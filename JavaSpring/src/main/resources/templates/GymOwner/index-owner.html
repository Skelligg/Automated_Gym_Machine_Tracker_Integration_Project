<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<div th:insert="~{fragments/navbar :: header(user=${user})}">header</div>


<div class="container mt-4">
    <div class="row align-items-center">
        <div class="col-6">
            <h1 class="display-5">Dashboard</h1>
        </div>

        <div class="col-6 text-end">
            <p class="fs-5" id="current-date"></p>
        </div>
    </div>
</div>

<div class="container mt-4">
    <div class="row">
        <!-- Notifications Panel -->
        <div class="col-md-5">
            <h3>Notifications</h3>
            <ul class="list-group" style="max-height: 300px; overflow-y: auto;">
                <li class="list-group-item">Cable Row is out of order <span class="badge bg-primary">New</span></li>
                <li class="list-group-item">Shoulder Press is due for maintenance <span class="badge bg-primary">New</span></li>
                <li class="list-group-item">Welcome to your dashboard!</li>
            </ul>
        </div>


        <!-- Machine Usage -->
        <div class="col-md-7">
            <h3>Machine Usage</h3>
            <canvas id="machineUsageChart"></canvas>
        </div>
    </div>



    <div class="row mt-2">
        <!-- Total Activity -->
        <div class="col-md-5" style="margin-top: -16vh;">
            <h3>Daily Activity</h3>
            <div style="position: relative; height: 45vh;">
                <canvas id="totalActivityChart"></canvas>
            </div>
        </div>

        <!-- Subscriptions Purchased -->
        <div class="col-md-7">
            <h3>Subscriptions Activity</h3>
            <canvas id="subscriptionsChart" style="max-height: 29vh"></canvas>
        </div>
    </div>
    <div class="row mt-3 align-items-center">
        <div class="col-md-5">
            <h3>Likelihood of Gym goers to discontinue membership, based on Gender</h3>
            <div style="position: relative; height: 40vh;">
                <canvas id="genderChart" width="100%" height="100%"></canvas>
            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">


    document.addEventListener("DOMContentLoaded", function () {
        const currentDate = new Date();
        const options = { year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('current-date').textContent = currentDate.toLocaleDateString(undefined, options);
    });

    /*<![CDATA[*/
    const labels_1 = /*[[${machineTopUsageKeys}]]*/ [];
    const data_1 = /*[[${machineTopUsageValues}]]*/ [];
    console.log('Labels:', labels_1);
    console.log('Data:', data_1);
    /*]]>*/

    const ctx1 = document.getElementById('machineUsageChart').getContext('2d');
    const machineUsageChart = new Chart(ctx1, {
        type: 'bar',
        data: {
            labels: labels_1,
            datasets: [{
                label: 'Usage',
                data: data_1,
                backgroundColor: 'rgba(0, 0, 0, 0.8)'
            }]
        }
    });

    /*<![CDATA[*/
    const labels_2 = /*[[${gymUsageKeys}]]*/ [];
    const data_2 = /*[[${gymUsageValues}]]*/ [];
    console.log('Labels:', labels_2);
    console.log('Data:', data_2);
    /*]]>*/

    const ctx2 = document.getElementById('totalActivityChart').getContext('2d');
    new Chart(ctx2, {
        type: 'line',
        data: {
            labels: labels_2,
            datasets: [{
                label: 'Total Activity (Units)',
                data: data_2, // Placeholder data
                borderColor: 'rgba(54, 162, 235, 1)',
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                tension: 0.3,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Time of Day'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Activity Level'
                    },
                    beginAtZero: true
                }
            }
        }
    });

    /*<![CDATA[*/
    const labels_3 = /*[[${gymUsageMonthlyKeys}]]*/ [];
    const data_3 = /*[[${gymUsageMonthlyValues}]]*/ [];
    console.log('Labels:', labels_3);
    console.log('Data:', data_3);
    /*]]>*/

    const ctx3 = document.getElementById('subscriptionsChart').getContext('2d');
    new Chart(ctx3, {
        type: 'line',
        data: {
            labels: labels_3,
            datasets: [
                {
                    label: 'Membership',
                    data: data_3,
                    backgroundColor: 'rgba(128, 128, 128, 1)',
                    borderColor: 'rgba(128, 128, 128, 1)',
                    borderWidth: 2,
                    pointBackgroundColor: 'rgba(128, 128, 128, 1)',
                    pointRadius: 5,
                    fill: false
                },
            ]
        },
        options: {
            responsive: true,
            scales: {
                x: {
                    type: 'category',
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Dec'],
                    title: {
                        display: true,
                        text: 'Month'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Subscriptions'
                    },
                    beginAtZero: true
                }
            }
        }
    });

    // the chart that displays the activity based on gender and how likely are they to give up

    const rawData = /*[[${genderSummary}]]*/ {};

    const data = rawData.data || [];

    const labels = data.map(entry=>entry.gender || 'Unknown')

    const dedicated = data.map(entry => entry.Dedicated || 0);

    const likelyToGiveUp = data.map(entry => entry["Likely to Give up"] || 0);

    console.log("Labels:", labels);
    console.log("Dedicated (%):", dedicated);
    console.log("Likely to Give Up (%):", likelyToGiveUp);


    const genderAnalyticsChart = document.getElementById('genderChart').getContext('2d');
        new Chart(genderAnalyticsChart, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Dedicated (%)',
                    data: dedicated,
                    backgroundColor: 'rgba(75, 192, 192)',
                    stack: 'stack1',
                },
                {
                    label: 'Likely to Give Up (%)',
                    data: likelyToGiveUp,
                    backgroundColor: 'rgba(255, 99, 132)',
                    stack: 'stack1',
                }
            ]
        },
        options: {
            responsive: true,
            scales: {
                x: {
                    beginAtZero: true
                },
                y: {
                    stacked: true,
                    beginAtZero: true,
                    max: 100
                }
            },
            plugins: {
                legend: {
                    position: 'top',
                }
            }
        }
    });
</script>

<!-- Bootstrap JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
